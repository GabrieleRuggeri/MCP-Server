# Customisation Guide

This document outlines common customisations that teams typically perform when
adapting the FastMCP template to production workloads.

## Swap the language model

Implement your own agent compatible with the `chat` coroutine signature:

```python
from dataclasses import dataclass


@dataclass
class CustomAgent:
    api_key: str

    async def chat(self, query: str) -> dict[str, str]:
        response = await call_external_api(self.api_key, query)
        return {"result": response}
```

Inject the agent through the server builder:

```python
from fastmcp_template import MCPServerBuilder

builder = MCPServerBuilder(lambda: CustomAgent(api_key="secret"))
```

## Register multiple tools

Extend the builder to register additional tools that expose separate capabilities
(e.g., `summarise`, `classify`). Each tool should map to a dedicated handler that
interacts with the agent or other backend services.

## Add authentication headers

Update `ClientSettings.extra_headers` to inject API keys or session tokens when
calling remote MCP servers:

```python
from fastmcp_template import ClientSettings, MCPClient

settings = ClientSettings(
    server_url="https://my.mcp.server",
    extra_headers={"Authorization": "Bearer <token>"},
)
client = MCPClient(settings=settings)
```

## Logging and observability

Instrument the handler generated by `MCPServerBuilder` by wrapping the agent call
with logging statements or tracing spans.

```python
import logging
from fastmcp_template import MCPServerBuilder

logger = logging.getLogger(__name__)

builder = MCPServerBuilder(create_agent)
handler = builder._build_handler(fastmcp)  # pylint: disable=protected-access
```

Consider subclassing `MCPServerBuilder` to keep custom logic contained and avoid
reaching into protected attributes.

## Deployment strategies

- **Local development**: Use `fastmcp serve main:main` (see `examples/run_server.py`).
- **Containerised environments**: Package the template as a Docker image and expose
  the server via the FastMCP CLI.
- **Serverless**: Wrap `MCPServerBuilder.build` inside your platform's request
  handler to lazily create the FastMCP app on cold starts.

## Testing tips

- Use the `fastmcp_module` override to inject fakes or mocks in unit tests.
- `MCPClient._extract_response_text` raises a descriptive error when the response
  payload cannot be converted to a stringâ€”use it to validate custom server
  responses.
